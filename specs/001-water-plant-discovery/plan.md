# Implementation Plan: V1 Water Plant Discovery Platform

**Branch**: `001-water-plant-discovery` | **Date**: 2026-01-17 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-water-plant-discovery/spec.md`

## Summary

Build the V1 FlowGrid platform enabling water plant owners to list their businesses and consumers to discover nearby plants via map-based search. The platform includes:
- **B2C Consumer App** (Flutter): Map discovery, plant details, real-time messaging with owners
- **B2B Owner App** (Flutter): Plant registration, profile management, document upload, chat with consumers
- **Admin Dashboard** (Next.js): Document verification, plant moderation, analytics
- **Backend API** (NestJS): RESTful API with WebSocket for real-time chat, PostgreSQL+PostGIS for geospatial queries

All infrastructure runs locally via Docker (PostgreSQL, Redis, MinIO) with no cloud dependencies for V1.

## Technical Context

**Language/Version**: TypeScript 5.x (Backend/Admin), Dart 3.x (Flutter Apps)
**Primary Dependencies**: NestJS 10.x, Next.js 14.x, Flutter 3.x, Prisma ORM
**Storage**: PostgreSQL 16 + PostGIS 3.4, Redis 7.x, MinIO (local S3-compatible)
**Testing**: Jest (Backend), Playwright (Admin E2E), Flutter test
**Target Platform**: Android (API 24+), iOS 15+, Web (Admin only)
**Project Type**: Multi-app monorepo (4 apps: backend, admin, consumer-app, owner-app)
**Performance Goals**: API <200ms p95, WebSocket <100ms delivery, Map renders <1s
**Constraints**: All storage local (no cloud), offline-capable mobile apps, E2E encrypted messaging
**Scale/Scope**: 1000 plants, 10k consumers, 50k messages/day for V1

## Constitution Check

*GATE: Verified against FlowGrid Constitution v1.0.0*

| Principle | Compliance | Notes |
|-----------|------------|-------|
| I. API-First | ✅ Pass | OpenAPI spec defined in contracts/openapi.yaml before implementation |
| II. DRY | ✅ Pass | Shared packages planned (flutter-ui), Prisma single source for models |
| III. Security by Design | ✅ Pass | JWT auth, AES-256-GCM message encryption, input validation |
| IV. Test-Driven Quality | ✅ Pass | Contract tests, E2E tests for critical flows in task requirements |
| V. Observability | ✅ Pass | Structured logging, request correlation IDs planned |
| VI. Scalability | ✅ Pass | Stateless services, Redis for sessions/cache, pagination on all lists |
| VII. Reproducibility | ✅ Pass | Docker Compose for all infra, Prisma migrations, pinned versions |

## Project Structure

### Documentation (this feature)

```text
specs/001-water-plant-discovery/
├── spec.md              # Feature specification with user stories
├── plan.md              # This file - implementation plan
├── research.md          # Technology research and decisions
├── data-model.md        # ERD, entity definitions, Prisma schema
├── quickstart.md        # Development environment setup guide
├── contracts/           # API contracts
│   └── openapi.yaml     # OpenAPI 3.0 specification
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
flowgrid/
├── apps/
│   ├── backend/                    # NestJS API server
│   │   ├── src/
│   │   │   ├── modules/
│   │   │   │   ├── auth/           # JWT authentication
│   │   │   │   ├── consumer/       # Consumer endpoints
│   │   │   │   ├── owner/          # Owner endpoints
│   │   │   │   ├── admin/          # Admin endpoints
│   │   │   │   ├── plants/         # Plant CRUD & geospatial
│   │   │   │   ├── chat/           # WebSocket messaging
│   │   │   │   ├── notifications/  # Push notifications
│   │   │   │   └── storage/        # MinIO file service
│   │   │   ├── common/
│   │   │   │   ├── guards/         # Auth guards
│   │   │   │   ├── filters/        # Exception filters
│   │   │   │   ├── interceptors/   # Logging, transform
│   │   │   │   └── decorators/     # Custom decorators
│   │   │   └── main.ts
│   │   ├── prisma/
│   │   │   ├── schema.prisma
│   │   │   ├── migrations/
│   │   │   └── seed.ts
│   │   └── test/
│   │       ├── contract/           # API contract tests
│   │       ├── integration/        # Database integration
│   │       └── unit/               # Service unit tests
│   │
│   ├── admin/                      # Next.js admin dashboard
│   │   ├── src/
│   │   │   ├── app/                # App router pages
│   │   │   │   ├── dashboard/
│   │   │   │   ├── verifications/
│   │   │   │   ├── plants/
│   │   │   │   └── users/
│   │   │   ├── components/
│   │   │   │   ├── ui/             # shadcn/ui components
│   │   │   │   └── features/       # Feature-specific
│   │   │   └── lib/
│   │   │       ├── api/            # API client (generated)
│   │   │       └── utils/
│   │   └── tests/
│   │       └── e2e/                # Playwright tests
│   │
│   ├── consumer-app/               # Flutter consumer app
│   │   ├── lib/
│   │   │   ├── core/
│   │   │   │   ├── api/            # API client
│   │   │   │   ├── di/             # Dependency injection
│   │   │   │   ├── routing/        # GoRouter config
│   │   │   │   └── theme/          # App theming
│   │   │   ├── features/
│   │   │   │   ├── auth/           # Login/OTP
│   │   │   │   ├── map/            # Plant discovery map
│   │   │   │   ├── plant_details/  # Plant detail view
│   │   │   │   ├── chat/           # Messaging feature
│   │   │   │   └── profile/        # User profile
│   │   │   └── main.dart
│   │   └── test/
│   │       ├── unit/
│   │       └── widget/
│   │
│   └── owner-app/                  # Flutter owner app
│       ├── lib/
│       │   ├── core/               # Same structure as consumer
│       │   ├── features/
│       │   │   ├── auth/           # Login/registration
│       │   │   ├── dashboard/      # Owner dashboard
│       │   │   ├── plant_profile/  # Plant management
│       │   │   ├── documents/      # Document upload
│       │   │   ├── chat/           # Messaging feature
│       │   │   └── notifications/  # Notification center
│       │   └── main.dart
│       └── test/
│
├── packages/                       # Shared packages (future)
│   └── flutter-ui/                 # Shared Flutter components
│
├── docker/
│   ├── docker-compose.yml          # Production compose
│   ├── docker-compose.dev.yml      # Development compose
│   └── Dockerfile.backend          # Backend container
│
├── .env.example
├── pnpm-workspace.yaml
└── README.md
```

**Structure Decision**: Multi-app monorepo with pnpm workspaces for Node.js apps (backend, admin) and Flutter apps (consumer-app, owner-app) in a flat `apps/` directory. This enables code sharing while allowing independent deployments.

## Architecture Overview

### System Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              CLIENTS                                     │
├─────────────────┬─────────────────┬─────────────────┬───────────────────┤
│  Consumer App   │   Owner App     │  Admin Dashboard │   Future: IoT    │
│  (Flutter)      │   (Flutter)     │  (Next.js)       │   Devices        │
│  Android/iOS    │   Android/iOS   │  Web             │                  │
└────────┬────────┴────────┬────────┴────────┬─────────┴──────────────────┘
         │                 │                 │
         │    REST API + WebSocket           │
         └────────────────┬──────────────────┘
                          │
┌─────────────────────────▼──────────────────────────────────────────────┐
│                        BACKEND (NestJS)                                 │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │
│  │ Auth Module  │  │ Plants Module│  │ Chat Module  │  │ Admin Module│ │
│  │ JWT + OTP    │  │ CRUD + Geo   │  │ WebSocket    │  │ Verification│ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └─────────────┘ │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │
│  │Storage Module│  │Notifications │  │ Consumer Mod │  │ Owner Module│ │
│  │ MinIO Client │  │ FCM + Local  │  │ Profile/Prefs│  │ Profile/Docs│ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └─────────────┘ │
└─────────────────────────┬──────────────────────────────────────────────┘
                          │
┌─────────────────────────▼──────────────────────────────────────────────┐
│                        DATA LAYER                                       │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────┐  ┌───────────────────────────┐ │
│  │ PostgreSQL 16    │  │ Redis 7      │  │ MinIO                     │ │
│  │ + PostGIS 3.4    │  │ Sessions     │  │ Photos & Documents        │ │
│  │ Geospatial       │  │ Cache        │  │ S3-Compatible API         │ │
│  │ Transactions     │  │ Pub/Sub      │  │ Local Storage             │ │
│  └──────────────────┘  └──────────────┘  └───────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

### Real-Time Messaging Architecture

```
┌──────────────────┐                    ┌──────────────────┐
│  Consumer App    │                    │   Owner App      │
│  ┌────────────┐  │                    │  ┌────────────┐  │
│  │ Chat BLoC  │  │                    │  │ Chat BLoC  │  │
│  └─────┬──────┘  │                    │  └─────┬──────┘  │
│        │         │                    │        │         │
│  ┌─────▼──────┐  │                    │  ┌─────▼──────┐  │
│  │ WebSocket  │  │                    │  │ WebSocket  │  │
│  │ Client     │  │                    │  │ Client     │  │
│  └─────┬──────┘  │                    │  └─────┬──────┘  │
└────────┼─────────┘                    └────────┼─────────┘
         │                                       │
         │         WebSocket (wss://)            │
         └─────────────────┬─────────────────────┘
                           │
              ┌────────────▼────────────┐
              │    NestJS Gateway       │
              │    (Socket.IO)          │
              │  ┌──────────────────┐   │
              │  │ Authentication   │   │
              │  │ JWT Validation   │   │
              │  └──────────────────┘   │
              │  ┌──────────────────┐   │
              │  │ Room Management  │   │
              │  │ conversation:{id}│   │
              │  └──────────────────┘   │
              │  ┌──────────────────┐   │
              │  │ Message Handling │   │
              │  │ Encrypt/Decrypt  │   │
              │  └──────────────────┘   │
              └────────────┬────────────┘
                           │
              ┌────────────▼────────────┐
              │    Redis Pub/Sub        │
              │    (Multi-instance)     │
              └────────────┬────────────┘
                           │
              ┌────────────▼────────────┐
              │    PostgreSQL           │
              │    Message Storage      │
              │    (Encrypted)          │
              └─────────────────────────┘
```

### Message Encryption Flow

```
Consumer sends message:
1. Client: plaintext → API (HTTPS)
2. Server: Generate AES-256-GCM key (per conversation)
3. Server: Encrypt plaintext → ciphertext + IV + authTag
4. Server: Store ciphertext in PostgreSQL
5. Server: Broadcast to recipient via WebSocket
6. Recipient: Request decryption → Server decrypts → plaintext

Note: Server-managed keys for V1. True E2E (client-side keys) deferred to V1.5.
```

## Key Technical Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Mobile Framework | Flutter | Single codebase for iOS/Android, fast development |
| Backend Framework | NestJS | TypeScript, modular architecture, WebSocket support |
| Database | PostgreSQL + PostGIS | Geospatial queries, ACID compliance, mature ecosystem |
| Cache/Sessions | Redis | Fast, pub/sub for WebSocket scaling |
| File Storage | MinIO | S3-compatible, runs locally, no cloud dependency |
| Real-time Transport | WebSocket (Socket.IO) | Industry standard, automatic reconnection |
| State Management | BLoC (Flutter) | Predictable state, testable, team familiarity |
| API Style | REST + WebSocket | REST for CRUD, WebSocket for real-time |
| Message Encryption | AES-256-GCM | Industry standard symmetric encryption |
| Key Management | Server-managed | Simpler for V1, enables message retention |

## Complexity Tracking

> No constitution violations identified. Structure follows recommended patterns.

| Aspect | Complexity | Justification |
|--------|------------|---------------|
| 4 Apps | Required | B2C (consumer), B2B (owner), Admin (web), Backend (API) serve distinct users |
| WebSocket + REST | Required | REST for CRUD operations, WebSocket for real-time chat |
| PostgreSQL + Redis + MinIO | Required | Each serves distinct purpose: data, cache/pubsub, files |

## Dependencies

### Backend (NestJS)

```json
{
  "@nestjs/core": "^10.0.0",
  "@nestjs/platform-express": "^10.0.0",
  "@nestjs/platform-socket.io": "^10.0.0",
  "@nestjs/websockets": "^10.0.0",
  "@nestjs/jwt": "^10.0.0",
  "@nestjs/passport": "^10.0.0",
  "@prisma/client": "^5.0.0",
  "minio": "^7.1.0",
  "ioredis": "^5.0.0",
  "class-validator": "^0.14.0",
  "class-transformer": "^0.5.0"
}
```

### Admin Dashboard (Next.js)

```json
{
  "next": "^14.0.0",
  "react": "^18.0.0",
  "@tanstack/react-query": "^5.0.0",
  "tailwindcss": "^3.4.0",
  "@radix-ui/react-*": "latest"
}
```

### Flutter Apps

```yaml
dependencies:
  flutter_bloc: ^8.1.0
  dio: ^5.0.0
  socket_io_client: ^2.0.0
  go_router: ^12.0.0
  google_maps_flutter: ^2.5.0
  geolocator: ^10.0.0
  flutter_secure_storage: ^9.0.0
  cached_network_image: ^3.3.0
```

## API Endpoints Summary

### Consumer Endpoints
- `POST /v1/consumer/auth/send-otp` - Request OTP
- `POST /v1/consumer/auth/verify-otp` - Verify and login
- `GET /v1/plants` - List nearby plants (geospatial)
- `GET /v1/plants/{id}` - Plant details
- `GET /v1/consumer/conversations` - List conversations
- `POST /v1/consumer/conversations` - Start conversation
- `GET /v1/consumer/conversations/{id}/messages` - Get messages
- `POST /v1/consumer/conversations/{id}/messages` - Send message

### Owner Endpoints
- `POST /v1/owner/auth/register` - Register owner
- `POST /v1/owner/auth/login` - Login
- `GET/PUT /v1/owner/plants/{id}` - Manage plant profile
- `POST /v1/owner/plants/{id}/photos` - Upload photos
- `POST /v1/owner/documents` - Upload verification docs
- `GET /v1/owner/conversations` - List conversations
- `GET/POST /v1/owner/conversations/{id}/messages` - Messages

### Admin Endpoints
- `POST /v1/admin/auth/login` - Admin login
- `GET /v1/admin/verifications` - Pending verifications
- `POST /v1/admin/verifications/{id}/approve` - Approve
- `POST /v1/admin/verifications/{id}/reject` - Reject

### WebSocket Events
- `message:send` - Send message (client → server)
- `message:new` - New message (server → client)
- `message:delivered` - Delivery confirmation
- `message:read` - Read receipt
- `typing:start/stop` - Typing indicators

## Next Steps

1. **Run `/speckit.tasks`** to generate implementation tasks from this plan
2. Tasks will be broken into phases:
   - Phase 1: Infrastructure & Backend Core
   - Phase 2: Owner App & Admin Dashboard
   - Phase 3: Consumer App & Chat Feature
   - Phase 4: Testing & Polish
3. Each task will include acceptance criteria aligned with spec requirements
